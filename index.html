<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Data Crawler Pro - SciFi Edition</title>
    <style>
        :root {
            --primary: #0f0f1a;
            --secondary: #1e1e2f;
            --accent: #00f0ff;
            --accent2: #ff00aa;
            --text: #e0e0ff;
            --text-dim: #a0a0b0;
            --success: #00ff88;
            --warning: #ffaa00;
            --error: #ff5555;
            --glow: 0 0 10px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }
        
        body {
            background-color: var(--primary);
            color: var(--text);
            padding: 20px;
            line-height: 1.6;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 240, 255, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 0, 170, 0.05) 0%, transparent 20%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            border: 1px solid var(--accent);
            border-radius: 8px;
            box-shadow: var(--glow) rgba(0, 240, 255, 0.2), var(--glow) rgba(255, 0, 170, 0.2);
            overflow: hidden;
            background-color: var(--secondary);
            position: relative;
        }
        
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), var(--accent2), transparent);
            animation: scanline 2s linear infinite;
        }
        
        @keyframes scanline {
            0% { transform: translateY(0); }
            100% { transform: translateY(100vh); }
        }
        
        header {
            padding: 20px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-bottom: 1px solid var(--accent);
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        header::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent), var(--accent2), transparent);
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
            color: var(--accent);
            text-shadow: var(--glow) rgba(0, 240, 255, 0.5);
            display: flex;
            align-items: center;
        }
        
        h1::before, h1::after {
            content: "//";
            color: var(--text-dim);
            margin: 0 10px;
            font-weight: normal;
        }
        
        .subtitle {
            color: var(--text-dim);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .config-panel {
            padding: 15px 20px;
            background-color: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(0, 240, 255, 0.2);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .config-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 200px;
            flex: 1;
        }
        
        .config-label {
            font-size: 0.8rem;
            color: var(--accent);
        }
        
        .config-input {
            background-color: var(--primary);
            border: 1px solid var(--accent);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .config-input::placeholder {
            color: var(--text-dim);
        }
        
        .controls {
            padding: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            border-bottom: 1px solid rgba(0, 240, 255, 0.2);
        }
        
        button {
            background: linear-gradient(to bottom, var(--secondary), var(--primary));
            color: var(--accent);
            border: 1px solid var(--accent);
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: var(--glow) rgba(0, 240, 255, 0.2);
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            background: linear-gradient(to bottom, var(--accent), rgba(0, 240, 255, 0.3));
            color: var(--primary);
            box-shadow: var(--glow) rgba(0, 240, 255, 0.4);
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        button::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -60%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(30deg);
            transition: all 0.5s ease;
        }
        
        button:hover::after {
            left: 100%;
        }
        
        button.secondary {
            color: var(--accent2);
            border-color: var(--accent2);
            box-shadow: var(--glow) rgba(255, 0, 170, 0.2);
        }
        
        button.secondary:hover {
            background: linear-gradient(to bottom, var(--accent2), rgba(255, 0, 170, 0.3));
            box-shadow: var(--glow) rgba(255, 0, 170, 0.4);
        }
        
        .status {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(0, 240, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--text-dim);
            flex-shrink: 0;
        }
        
        .status.active .status-indicator {
            background-color: var(--accent);
            box-shadow: var(--glow) var(--accent);
            animation: pulse 1.5s infinite;
        }
        
        .status.success .status-indicator {
            background-color: var(--success);
            box-shadow: var(--glow) var(--success);
        }
        
        .status.error .status-indicator {
            background-color: var(--error);
            box-shadow: var(--glow) var(--error);
        }
        
        .status.warning .status-indicator {
            background-color: var(--warning);
            box-shadow: var(--glow) var(--warning);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .status-message {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .terminal {
            padding: 20px;
            background-color: var(--primary);
            border: 1px solid var(--accent);
            border-radius: 4px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-bottom: 20px;
            position: relative;
        }
        
        .terminal::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(transparent 95%, rgba(0, 240, 255, 0.05) 100%);
            pointer-events: none;
            background-size: 100% 20px;
        }
        
        .terminal-line {
            margin-bottom: 5px;
            white-space: pre-wrap;
            word-break: break-all;
            border-left: 2px solid var(--accent);
            padding-left: 10px;
            animation: appear 0.3s ease;
            display: flex;
            gap: 10px;
        }
        
        .terminal-timestamp {
            color: var(--text-dim);
            flex-shrink: 0;
        }
        
        .terminal-content {
            flex: 1;
        }
        
        @keyframes appear {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .terminal-line.error {
            color: var(--error);
            border-left-color: var(--error);
        }
        
        .terminal-line.warning {
            color: var(--warning);
            border-left-color: var(--warning);
        }
        
        .terminal-line.success {
            color: var(--success);
            border-left-color: var(--success);
        }
        
        .terminal-line.info {
            color: var(--accent);
            border-left-color: var(--accent);
        }
        
        .terminal-line.debug {
            color: var(--text-dim);
            border-left-color: var(--text-dim);
            font-size: 0.8rem;
        }
        
        .results {
            padding: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border: 1px solid var(--accent);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 240, 255, 0.2);
        }
        
        th {
            background-color: rgba(0, 240, 255, 0.1);
            color: var(--accent);
            font-weight: normal;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }
        
        tr:hover {
            background-color: rgba(0, 240, 255, 0.05);
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--accent);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            flex-shrink: 0;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .progress-container {
            width: 100%;
            background-color: var(--primary);
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
            border: 1px solid var(--accent);
            height: 10px;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--accent), var(--accent2));
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.3), 
                transparent);
            animation: progressGlow 2s linear infinite;
        }
        
        @keyframes progressGlow {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .progress-text {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            color: var(--text);
            text-shadow: 0 0 5px var(--primary);
            pointer-events: none;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--accent);
            border-radius: 4px;
            padding: 10px 15px;
            min-width: 120px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            color: var(--accent);
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        footer {
            padding: 15px 20px;
            text-align: center;
            color: var(--text-dim);
            font-size: 0.8rem;
            border-top: 1px solid rgba(0, 240, 255, 0.2);
        }
        
        /* Animation classes */
        .glow {
            animation: glowAnimation 2s infinite alternate;
        }
        
        @keyframes glowAnimation {
            from { opacity: 0.7; }
            to { opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .controls, .config-panel {
                flex-direction: column;
            }
            
            .config-input, #outputFilename {
                width: 100%;
            }
            
            .terminal {
                max-height: 300px;
                font-size: 0.8rem;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Anime Data Crawler Pro</h1>
            <p class="subtitle">Hệ thống trích xuất thông tin anime từ nguồn dữ liệu công khai</p>
        </header>
        
        <div class="config-panel">
            <div class="config-group">
                <label class="config-label">URL Nguồn Dữ Liệu</label>
                <input type="text" class="config-input" id="dataSourceUrl" 
                    value="https://raw.githubusercontent.com/niyakipham/data/refs/heads/main/anisub/data.txt">
            </div>
            <div class="config-group">
                <label class="config-label">Tên File Đầu Ra</label>
                <input type="text" class="config-input" id="outputFilename" 
                    placeholder="Nhập tên file (ví dụ: data.csv)" value="anime_data.csv">
            </div>
            <div class="config-group">
                <label class="config-label">Số Luồng Xử Lý</label>
                <select class="config-input" id="threadCount">
                    <option value="1">1 luồng</option>
                    <option value="3" selected>3 luồng</option>
                    <option value="5">5 luồng</option>
                    <option value="10">10 luồng</option>
                </select>
            </div>
        </div>
        
        <div class="controls">
            <button id="runBtn">
                <span>Chạy Crawler</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7"></path>
                </svg>
            </button>
            <button id="stopBtn" class="secondary hidden">
                <span>Dừng Lại</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="6" y="6" width="12" height="12" rx="1"></rect>
                </svg>
            </button>
            <button id="downloadBtn" class="hidden">
                <span>Tải Xuống</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
            </button>
            <button id="viewRawBtn" class="secondary hidden">
                <span>Xem Dữ Liệu</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
            </button>
            <button id="clearBtn" class="secondary">
                <span>Xóa Terminal</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
            </button>
        </div>
        
        <div class="status">
            <div class="status-indicator"></div>
            <div class="status-message">Sẵn sàng</div>
        </div>
        
        <div class="progress-container hidden">
            <div class="progress-bar"></div>
            <div class="progress-text">0%</div>
        </div>
        
        <div class="terminal" id="terminal"></div>
        
        <div class="results hidden" id="results">
            <h2>Kết Quả Trích Xuất</h2>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="statTotalUrls">0</div>
                    <div class="stat-label">URL đã xử lý</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statTotalEpisodes">0</div>
                    <div class="stat-label">Tập phim</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statSuccessRate">100%</div>
                    <div class="stat-label">Tỉ lệ thành công</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statTimeElapsed">0s</div>
                    <div class="stat-label">Thời gian</div>
                </div>
            </div>
            
            <div id="resultsTable"></div>
        </div>
        
        <footer>
            Hệ thống Anime Data Crawler Pro - Phiên bản SciFi | © 2023 - Sử dụng dữ liệu từ GitHub
        </footer>
    </div>

    <script>
        // ==============================================
        // CẤU HÌNH HỆ THỐNG
        // ==============================================
        const DEFAULT_DATA_URL = 'https://raw.githubusercontent.com/niyakipham/data/refs/heads/main/anisub/data.txt';
        
        // DOM Elements
        const DOM = {
            terminal: document.getElementById('terminal'),
            runBtn: document.getElementById('runBtn'),
            stopBtn: document.getElementById('stopBtn'),
            downloadBtn: document.getElementById('downloadBtn'),
            viewRawBtn: document.getElementById('viewRawBtn'),
            clearBtn: document.getElementById('clearBtn'),
            dataSourceUrl: document.getElementById('dataSourceUrl'),
            outputFilename: document.getElementById('outputFilename'),
            threadCount: document.getElementById('threadCount'),
            status: document.querySelector('.status'),
            statusIndicator: document.querySelector('.status-indicator'),
            statusMessage: document.querySelector('.status-message'),
            progressContainer: document.querySelector('.progress-container'),
            progressBar: document.querySelector('.progress-bar'),
            progressText: document.querySelector('.progress-text'),
            results: document.getElementById('results'),
            resultsTable: document.getElementById('resultsTable'),
            statTotalUrls: document.getElementById('statTotalUrls'),
            statTotalEpisodes: document.getElementById('statTotalEpisodes'),
            statSuccessRate: document.getElementById('statSuccessRate'),
            statTimeElapsed: document.getElementById('statTimeElapsed')
        };
        
        // Biến toàn cục
        let state = {
            isRunning: false,
            abortController: null,
            csvData: '',
            stats: {
                totalUrls: 0,
                processedUrls: 0,
                successUrls: 0,
                errorUrls: 0,
                totalEpisodes: 0,
                startTime: null,
                endTime: null
            }
        };
        
        // ==============================================
        // TIỆN ÍCH HỖ TRỢ
        // ==============================================
        
        // Lấy thời gian hiện tại định dạng HH:MM:SS
        function getCurrentTimestamp() {
            const now = new Date();
            return now.toLocaleTimeString('vi-VN', { hour12: false });
        }
        
        // Thêm dòng vào terminal
        function addTerminalLine(content, type = 'normal', isDebug = false) {
            const line = document.createElement('div');
            line.className = `terminal-line ${type} ${isDebug ? 'debug' : ''}`;
            
            const timestamp = document.createElement('span');
            timestamp.className = 'terminal-timestamp';
            timestamp.textContent = `[${getCurrentTimestamp()}]`;
            
            const contentSpan = document.createElement('span');
            contentSpan.className = 'terminal-content';
            contentSpan.textContent = content;
            
            line.appendChild(timestamp);
            line.appendChild(contentSpan);
            DOM.terminal.appendChild(line);
            DOM.terminal.scrollTop = DOM.terminal.scrollHeight;
            
            // Lưu log vào bộ nhớ
            if (isDebug) {
                console.debug(content);
            } else if (type === 'error') {
                console.error(content);
            } else if (type === 'warning') {
                console.warn(content);
            } else {
                console.log(content);
            }
        }
        
        // Cập nhật trạng thái hệ thống
        function updateStatus(message, type = 'normal') {
            DOM.status.className = 'status';
            DOM.statusMessage.textContent = message;
            
            if (type === 'active') {
                DOM.status.classList.add('active');
            } else if (type === 'success') {
                DOM.status.classList.add('success');
            } else if (type === 'error') {
                DOM.status.classList.add('error');
            } else if (type === 'warning') {
                DOM.status.classList.add('warning');
            }
        }
        
        // Hiển thị thanh tiến trình
        function showProgress(visible) {
            DOM.progressContainer.classList.toggle('hidden', !visible);
            if (visible) {
                updateProgress(0);
            }
        }
        
        // Cập nhật tiến trình
        function updateProgress(percent) {
            DOM.progressBar.style.width = `${percent}%`;
            DOM.progressText.textContent = `${Math.round(percent)}%`;
        }
        
        // Xóa terminal
        function clearTerminal() {
            DOM.terminal.innerHTML = '';
            updateStatus('Sẵn sàng');
        }
        
        // Cập nhật thống kê
        function updateStats() {
            DOM.statTotalUrls.textContent = state.stats.processedUrls;
            DOM.statTotalEpisodes.textContent = state.stats.totalEpisodes;
            
            const successRate = state.stats.processedUrls > 0 
                ? Math.round((state.stats.successUrls / state.stats.processedUrls) * 100) 
                : 100;
            DOM.statSuccessRate.textContent = `${successRate}%`;
            
            if (state.stats.startTime) {
                const elapsed = state.stats.endTime 
                    ? (state.stats.endTime - state.stats.startTime) / 1000
                    : (Date.now() - state.stats.startTime) / 1000;
                DOM.statTimeElapsed.textContent = `${elapsed.toFixed(1)}s`;
            }
        }
        
        // Hiển thị kết quả
        function showResults() {
            DOM.results.classList.remove('hidden');
            DOM.downloadBtn.classList.remove('hidden');
            DOM.viewRawBtn.classList.remove('hidden');
            
            // Chỉ hiển thị 10 dòng đầu tiên
            const rows = state.csvData.split('\n');
            const headers = rows[0].split(',').map(h => h.replace(/"/g, ''));
            const tableRows = rows.slice(1, 11); // Lấy tối đa 10 dòng
            
            // Tạo bảng HTML
            let tableHTML = `<table>
                <thead>
                    <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                </thead>
                <tbody>`;
            
            // Thêm dữ liệu vào bảng
            tableRows.forEach(row => {
                const cells = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/"/g, ''));
                tableHTML += `<tr>${cells.map(c => `<td>${c}</td>`).join('')}</tr>`;
            });
            
            tableHTML += `</tbody></table>`;
            
            // Thêm thông tin nếu có nhiều dữ liệu
            if (rows.length > 11) {
                tableHTML += `<p class="subtitle">Hiển thị 10/${rows.length - 1} dòng đầu tiên. Tải file CSV để xem đầy đủ.</p>`;
            }
            
            DOM.resultsTable.innerHTML = tableHTML;
            updateStats();
        }
        
        // Tải file CSV
        function downloadCSV() {
            if (!state.csvData) return;
            
            const blob = new Blob([state.csvData], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', DOM.outputFilename.value);
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            addTerminalLine(`Đã tải xuống file: ${DOM.outputFilename.value}`, 'success');
        }
        
        // Xem dữ liệu thô
        function viewRawData() {
            if (!state.csvData) return;
            
            const rawWindow = window.open();
            rawWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Raw Data: ${DOM.outputFilename.value}</title>
                    <style>
                        body { 
                            font-family: monospace; 
                            white-space: pre; 
                            padding: 20px; 
                            background-color: #0f0f1a;
                            color: #e0e0ff;
                        }
                    </style>
                </head>
                <body>${state.csvData.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</body>
                </html>
            `);
        }
        
        // Dừng quá trình
        function stopProcess() {
            if (state.abortController) {
                state.abortController.abort();
                addTerminalLine('Đã dừng quá trình crawl dữ liệu', 'warning');
                updateStatus('Đã dừng', 'warning');
                state.stats.endTime = Date.now();
                updateStats();
            }
        }
        
        // ==============================================
        // CORE CRAWLER FUNCTIONS
        // ==============================================
        
        // Lấy nội dung trang web với bộ đệm và xử lý lỗi
        async function fetchUrl(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: state.abortController?.signal,
                    cache: 'force-cache'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.text();
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw error; // Bỏ qua lỗi hủy
                }
                throw new Error(`Không thể tải URL: ${url} - ${error.message}`);
            }
        }
        
        // Phân tích cú pháp HTML để lấy thông tin
        function parseHtml(html) {
            const parser = new DOMParser();
            return parser.parseFromString(html, 'text/html');
        }
        
        // Trích xuất tiêu đề chính từ trang
        function extractMainTitle(doc) {
            const titleElement = doc.querySelector('h1.heading_movie');
            return titleElement ? titleElement.textContent.trim() : 'Không có tiêu đề';
        }
        
        // Trích xuất liên kết tập phim
        function extractEpisodeLinks(doc) {
            const episodeDiv = doc.querySelector('div.list-item-episode.scroll-bar');
            if (!episodeDiv) return [];
            
            const links = Array.from(episodeDiv.querySelectorAll('a')).map(a => a.href);
            return links.filter(link => link && link.trim() !== '');
        }
        
        // Trích xuất tiêu đề tập phim
        function extractEpisodeTitles(doc) {
            const episodeDiv = doc.querySelector('div.list-item-episode.scroll-bar');
            if (!episodeDiv) return [];
            
            const titles = [];
            const spans = episodeDiv.querySelectorAll('span');
            
            spans.forEach(span => {
                const text = span.textContent.trim();
                if (text && !text.includes('<') && !text.includes('>')) {
                    titles.push(text);
                }
            });
            
            return titles;
        }
        
        // Trích xuất URL video từ trang tập phim
        function extractVideoUrl(doc) {
            const videoDiv = doc.getElementById('video-player');
            if (!videoDiv) return null;
            
            const iframe = videoDiv.querySelector('iframe');
            return iframe ? iframe.src : null;
        }
        
        // Xử lý một URL chính
        async function processMainUrl(url, index) {
            if (!state.isRunning) return null;
            
            try {
                addTerminalLine(`Đang xử lý URL ${index + 1}: ${url}`, 'info');
                
                // Lấy nội dung trang chính
                const mainPageContent = await fetchUrl(url);
                const mainDoc = parseHtml(mainPageContent);
                
                // Trích xuất thông tin
                const mainTitle = extractMainTitle(mainDoc);
                const episodeLinks = extractEpisodeLinks(mainDoc);
                const episodeTitles = extractEpisodeTitles(mainDoc);
                
                if (episodeLinks.length === 0) {
                    throw new Error('Không tìm thấy liên kết tập phim');
                }
                
                if (episodeTitles.length !== episodeLinks.length) {
                    addTerminalLine(`Cảnh báo: Số tiêu đề tập (${episodeTitles.length}) không khớp với số liên kết (${episodeLinks.length})`, 'warning');
                }
                
                // Xử lý từng tập phim
                const episodeResults = [];
                for (let i = 0; i < episodeLinks.length; i++) {
                    if (!state.isRunning) break;
                    
                    try {
                        const episodeLink = episodeLinks[i];
                        const episodeTitle = i < episodeTitles.length ? episodeTitles[i] : `Tập ${i + 1}`;
                        
                        addTerminalLine(`Đang xử lý tập ${i + 1}: ${episodeTitle}`, 'debug');
                        
                        // Lấy nội dung trang tập phim
                        const episodePageContent = await fetchUrl(episodeLink);
                        const episodeDoc = parseHtml(episodePageContent);
                        
                        // Trích xuất URL video
                        const videoUrl = extractVideoUrl(episodeDoc) || 'Không tìm thấy URL video';
                        
                        episodeResults.push({
                            mainTitle,
                            episodeTitle,
                            videoUrl
                        });
                        
                        addTerminalLine(`Đã xử lý thành công tập ${i + 1}`, 'debug');
                    } catch (error) {
                        addTerminalLine(`Lỗi khi xử lý tập phim: ${error.message}`, 'error');
                    }
                }
                
                state.stats.successUrls++;
                state.stats.totalEpisodes += episodeResults.length;
                updateStats();
                
                return episodeResults;
            } catch (error) {
                state.stats.errorUrls++;
                updateStats();
                
                addTerminalLine(`Lỗi khi xử lý URL chính ${index + 1}: ${error.message}`, 'error');
                return null;
            } finally {
                state.stats.processedUrls++;
                const progress = (state.stats.processedUrls / state.stats.totalUrls) * 100;
                updateProgress(progress);
                updateStats();
            }
        }
        
        // Hàm chính để chạy crawler
        async function runCrawler() {
            // Kiểm tra tên file đầu ra
            const outputFile = DOM.outputFilename.value.trim();
            if (!outputFile.endsWith('.csv')) {
                addTerminalLine('Lỗi: Tên file đầu ra phải kết thúc bằng .csv', 'error');
                updateStatus('Lỗi: Tên file không hợp lệ', 'error');
                return;
            }
            
            // Đặt lại trạng thái
            state = {
                isRunning: true,
                abortController: new AbortController(),
                csvData: '',
                stats: {
                    totalUrls: 0,
                    processedUrls: 0,
                    successUrls: 0,
                    errorUrls: 0,
                    totalEpisodes: 0,
                    startTime: Date.now(),
                    endTime: null
                }
            };
            
            // Cập nhật giao diện
            DOM.runBtn.classList.add('hidden');
            DOM.stopBtn.classList.remove('hidden');
            DOM.results.classList.add('hidden');
            DOM.downloadBtn.classList.add('hidden');
            DOM.viewRawBtn.classList.add('hidden');
            showProgress(true);
            clearTerminal();
            
            try {
                // Lấy dữ liệu URL từ nguồn
                const dataUrl = DOM.dataSourceUrl.value.trim() || DEFAULT_DATA_URL;
                updateStatus(`Đang kết nối đến nguồn dữ liệu: ${dataUrl}`, 'active');
                addTerminalLine(`Bắt đầu quá trình crawl dữ liệu anime từ: ${dataUrl}`, 'info');
                
                const rawData = await fetchUrl(dataUrl);
                const urls = rawData.split('\n')
                    .map(url => url.trim())
                    .filter(url => url && url.startsWith('http'));
                
                if (urls.length === 0) {
                    throw new Error('Không tìm thấy URL hợp lệ trong dữ liệu nguồn');
                }
                
                state.stats.totalUrls = urls.length;
                updateStats();
                
                addTerminalLine(`Đã tải xuống ${urls.length} URL từ nguồn dữ liệu.`, 'success');
                addTerminalLine('Bắt đầu trích xuất thông tin từ các URL...', 'info');
                
                // Tạo header CSV
                let csvRows = ['"Title","Episode","URL"'];
                
                // Xử lý từng URL theo luồng
                const threadCount = parseInt(DOM.threadCount.value) || 3;
                addTerminalLine(`Sử dụng ${threadCount} luồng xử lý đồng thời...`, 'info');
                
                for (let i = 0; i < urls.length; i += threadCount) {
                    if (!state.isRunning) break;
                    
                    const batch = urls.slice(i, i + threadCount);
                    const batchResults = await Promise.all(
                        batch.map((url, idx) => processMainUrl(url, i + idx))
                    );
                    
                    // Thêm kết quả vào CSV
                    batchResults.forEach(result => {
                        if (result && result.length > 0) {
                            result.forEach(episode => {
                                const escapedTitle = episode.mainTitle.replace(/"/g, '""');
                                const escapedEpisode = episode.episodeTitle.replace(/"/g, '""');
                                const escapedUrl = episode.videoUrl.replace(/"/g, '""');
                                csvRows.push(`"${escapedTitle}","${escapedEpisode}","${escapedUrl}"`);
                            });
                        }
                    });
                }
                
                if (!state.isRunning) {
                    return; // Đã dừng
                }
                
                // Lưu dữ liệu CSV
                state.csvData = csvRows.join('\n');
                
                // Hiển thị kết quả
                state.stats.endTime = Date.now();
                showResults();
                updateStatus(`Hoàn thành! Đã xử lý ${urls.length} URL và tìm thấy ${csvRows.length - 1} tập phim.`, 'success');
                addTerminalLine('Quá trình crawl dữ liệu đã hoàn thành!', 'success');
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    state.stats.endTime = Date.now();
                    addTerminalLine(`Lỗi: ${error.message}`, 'error');
                    updateStatus('Lỗi khi thực hiện crawl dữ liệu', 'error');
                }
            } finally {
                state.isRunning = false;
                DOM.runBtn.classList.remove('hidden');
                DOM.stopBtn.classList.add('hidden');
                showProgress(false);
            }
        }
        
        // ==============================================
        // EVENT HANDLERS
        // ==============================================
        
        // Sự kiện click nút chạy
        DOM.runBtn.addEventListener('click', () => {
            if (state.isRunning) {
                addTerminalLine('Có một quá trình đang chạy. Vui lòng đợi...', 'warning');
                return;
            }
            
            runCrawler().catch(err => {
                addTerminalLine(`Lỗi không mong muốn: ${err.message}`, 'error');
            });
        });
        
        // Sự kiện click nút dừng
        DOM.stopBtn.addEventListener('click', () => {
            if (state.isRunning) {
                state.isRunning = false;
                stopProcess();
            }
        });
        
        // Sự kiện click nút tải xuống
        DOM.downloadBtn.addEventListener('click', downloadCSV);
        
        // Sự kiện click nút xem raw
        DOM.viewRawBtn.addEventListener('click', viewRawData);
        
        // Sự kiện click nút xóa terminal
        DOM.clearBtn.addEventListener('click', clearTerminal);
        
        // Thêm thông báo khi tải trang
        addTerminalLine('Hệ thống Anime Data Crawler Pro đã sẵn sàng.', 'info');
        addTerminalLine(`URL nguồn dữ liệu mặc định: ${DEFAULT_DATA_URL}`, 'info');
        addTerminalLine('Nhập tên file đầu ra và nhấn "Chạy Crawler" để bắt đầu.', 'info');
    </script>
</body>
</html>
